# templates/deployment.yaml — описывает Kubernetes Deployment для запуска ClickHouse
# Deployment управляет репликацией Pod и их обновлением
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "clickhouse.fullname" . }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "clickhouse.labels" . | nindent 4 }}
spec:
  # Количество реплик Pod (в данном случае 1, так как это single-инсталляция)
  replicas: {{ .Values.replicaCount }}
  selector:
    # Selector для выбора Pod, управляемых этим Deployment
    matchLabels:
      {{- include "clickhouse.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      # Аннотации для Pod (используются для мониторинга, логирования и т.п.)
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/configmap-users.yaml") . | sha256sum }}
        checksum/secret: {{ include (print $.Template.BasePath "/secret-users.yaml") . | sha256sum }}
      labels:
        {{- include "clickhouse.selectorLabels" . | nindent 8 }}
    spec:
      # Контейнеры в Pod
      containers:
      - name: clickhouse
        # Образ ClickHouse (repository:tag из values.yaml)
        image: "{{ .Values.clickhouse.image.repository }}:{{ .Values.clickhouse.image.tag }}"
        # Политика загрузки образа
        imagePullPolicy: {{ .Values.clickhouse.image.pullPolicy }}
        
        # Порты, которые слушает контейнер
        ports:
        # HTTP интерфейс для веб-запросов и HTTP API
        - name: http
          containerPort: {{ .Values.service.httpPort }}
          protocol: TCP
        # Native протокол ClickHouse (бинарный протокол для клиентов)
        - name: native
          containerPort: {{ .Values.service.nativePort }}
          protocol: TCP
        
        # Ресурсы (запросы и лимиты CPU/Memory)
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
        
        # Переменные окружения для контейнера
        env:
        # Переменная окружения LOG_LEVEL для контроля уровня логирования
        - name: LOG_LEVEL
          value: "information"
        
        # Volume mounts — монтирование хранилищ в файловую систему контейнера
        volumeMounts:
        # Монтирование ConfigMap с пользователями в директорию конфигураций ClickHouse
        - name: users-config
          mountPath: /etc/clickhouse-server/users.d/
          readOnly: true
        # Монтирование Secret с паролями (используется конфигурацией пользователей)
        - name: users-secret
          mountPath: /etc/clickhouse-server/secrets/
          readOnly: true
        # Монтирование PersistentVolumeClaim для хранения данных ClickHouse
        - name: data
          mountPath: /var/lib/clickhouse/
        
        # Проверка готовности Pod к приёму трафика (readiness probe)
        readinessProbe:
          # Используем HTTP GET запрос для проверки доступности
          httpGet:
            path: /ping
            port: http
          initialDelaySeconds: {{ .Values.healthcheck.initialDelaySeconds }}
          periodSeconds: {{ .Values.healthcheck.periodSeconds }}
          timeoutSeconds: {{ .Values.healthcheck.timeoutSeconds }}
          failureThreshold: {{ .Values.healthcheck.failureThreshold }}
        
        # Проверка живого состояния Pod (liveness probe)
        livenessProbe:
          httpGet:
            path: /ping
            port: http
          initialDelaySeconds: {{ add .Values.healthcheck.initialDelaySeconds 10 }}
          periodSeconds: {{ .Values.healthcheck.periodSeconds }}
          timeoutSeconds: {{ .Values.healthcheck.timeoutSeconds }}
          failureThreshold: {{ .Values.healthcheck.failureThreshold }}
      
      # Volumes — определение хранилищ (ConfigMap, Secret, PVC)
      volumes:
      # Volume на основе ConfigMap (конфигурация пользователей)
      - name: users-config
        configMap:
          name: {{ include "clickhouse.fullname" . }}-users-config
      # Volume на основе Secret (пароли пользователей)
      - name: users-secret
        secret:
          secretName: {{ include "clickhouse.fullname" . }}-users-secret
      # Volume на основе PersistentVolumeClaim (хранилище данных)
      - name: data
        persistentVolumeClaim:
          claimName: {{ include "clickhouse.fullname" . }}-data
      
      # Селекторы узлов (если нужно привязать Pod к конкретным узлам)
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      # Толерации (для развёртывания на узлах с taints)
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      
      # Affinity-правила (для управления распределением Pod)
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}

---
# PersistentVolumeClaim — запрос на выделение хранилища
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "clickhouse.fullname" . }}-data
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "clickhouse.labels" . | nindent 4 }}
spec:
  # Режим доступа (ReadWriteOnce — чтение и запись только одним Pod одновременно)
  accessModes:
    - ReadWriteOnce
  # Класс хранилища (должен существовать в кластере)
  storageClassName: {{ .Values.storage.storageClassName }}
  resources:
    requests:
      # Размер запрашиваемого хранилища
      storage: {{ .Values.storage.size }}
